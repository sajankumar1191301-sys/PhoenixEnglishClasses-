<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Phoenix English Classes - Cosmic Platform (Updated)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --accent1: #7b5cff;
  --accent2: #4ca0ff;
  --glass-bg: rgba(255,255,255,0.06);
  --glass-border: rgba(255,255,255,0.08);
  --dark-bg: #02000a;
  --light-text: #eaeaea;
  --ease: cubic-bezier(0.215,0.610,0.355,1);
}

/* --- Basic layout & fonts --- */
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
body{min-height:100vh;background:#02000a;color:var(--light-text);display:flex;align-items:center;justify-content:center;padding:20px;overflow:hidden}

/* Nebula & canvas (kept from original style) */
#nebula{position:fixed;top:0;left:0;width:150%;height:150%;background-image:url('https://w.forfun.com/fetch/5d/5d32d32ed3a2b47d3330f63b20af280c.jpeg');background-size:cover;z-index:-3;opacity:0.35;transform:translate(0,0)}
#cosmic-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2}

/* Phone container */
.phone{width:390px;height:844px;max-width:98vw;border-radius:40px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.2));box-shadow:0 20px 60px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.04);overflow:hidden;display:flex;flex-direction:column}
header{background:linear-gradient(135deg,#ff6bb5,var(--accent1));padding:18px;border-bottom-left-radius:22px;border-bottom-right-radius:22px;color:#fff}
.header-inner{display:flex;align-items:center;justify-content:space-between}
.logo-area{display:flex;gap:10px;align-items:center}
.logo-area img{width:56px;height:56px;border-radius:12px;object-fit:cover;background:rgba(255,255,255,0.06);padding:6px}
.header-text h1{font-size:20px;font-weight:900;line-height:1}
.header-text p{font-size:12px;opacity:0.95;margin-top:4px}

/* Nav tabs */
.nav-tabs{display:flex;background:rgba(255,255,255,0.02);margin:14px;border-radius:12px;overflow:hidden;padding:4px;border:1px solid rgba(255,255,255,0.03)}
.nav-tab{flex:1;padding:8px 10px;text-align:center;font-size:13px;font-weight:700;color:rgba(255,255,255,0.7);border-radius:9px;cursor:pointer}
.nav-tab.active{background:rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(0,0,0,0.5);color:#fff}

/* content */
.phone-content{flex:1;overflow-y:auto;padding:12px}
.course-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:16px;margin-bottom:14px;border:1px solid rgba(255,255,255,0.03)}
.course-card h2{font-size:16px;font-weight:800}
.summary{font-size:13px;color:rgba(255,255,255,0.75);margin-top:6px}

/* Animated primary button */
.btn-primary{
  display:inline-block;width:100%;padding:12px 14px;border-radius:12px;font-weight:700;font-size:15px;border:none;cursor:pointer;
  background:linear-gradient(270deg,#6a11cb,#2575fc,#6a11cb);background-size:400% 400%;
  color:#fff;box-shadow:0 8px 20px rgba(107,78,255,0.18);transition:transform .22s var(--ease),box-shadow .22s var(--ease);
  animation:gradientFlow 4s ease infinite;
}
@keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.btn-primary:active{transform:scale(0.98)}
.btn-secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:10px;color:#fff}

/* Styled select (glassy) */
.styled-select-group{display:flex;gap:10px;margin-bottom:12px}
.styled-select-group select{
  flex:1;appearance:none;-webkit-appearance:none;padding:10px 38px 10px 12px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:#fff;font-weight:600;cursor:pointer;backdrop-filter:blur(6px);background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>');background-repeat:no-repeat;background-position:right 10px center;transition:box-shadow .2s, transform .2s}
.styled-select-group select:hover{box-shadow:0 0 10px rgba(123,92,255,0.35);transform:translateY(-2px)}
.styled-select-group select:focus{outline:none;border-color:var(--accent1);box-shadow:0 0 12px rgba(123,92,255,0.6)}

/* modal base */
.modal{display:none;position:fixed;z-index:2000;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.modal-content{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));padding:20px;border-radius:16px;border:1px solid rgba(255,255,255,0.04);width:360px;max-width:92vw;max-height:92vh;overflow-y:auto}
.close-modal{position:absolute;right:12px;top:8px;background:rgba(255,255,255,0.06);border-radius:999px;border:none;padding:6px;font-size:18px;color:#fff;cursor:pointer}

/* forms */
.form-group{margin-bottom:12px}
.form-group label{display:block;margin-bottom:6px;font-weight:700;font-size:13px;color:rgba(255,255,255,0.85)}
.form-group input,.form-group select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:#fff;font-size:14px}
.error-msg{color:#ff7a7a;font-size:13px;margin-top:6px;display:none}

/* content viewer (full-screen) */
.content-viewer{display:none;position:fixed;inset:0;z-index:4000;background:#000;align-items:center;justify-content:center;padding:0}
.video-shell{position:relative;width:100%;height:100%;display:flex;flex-direction:column}
#videoPlayerIframe{width:100%;height:100%;border:0;background:#000}
.video-controls{
  position:absolute;left:12px;right:12px;bottom:18px;display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.45));border-radius:12px;
}

/* custom control buttons */
.icon-btn{background:rgba(255,255,255,0.06);border:0;padding:8px 12px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}
.seek-slider{flex:1;margin:0 8px}
.time-label{font-size:13px;color:#fff;min-width:54px;text-align:center}

/* small helpers */
.hidden{display:none}
.small{font-size:12px;color:rgba(255,255,255,0.85)}

/* responsive */
@media (max-width:420px){.phone{width:100%;height:100vh;border-radius:0}}
</style>
</head>
<body>

<div id="nebula"></div>
<canvas id="cosmic-canvas"></canvas>

<!-- MODALS -->
<div id="authModal" class="modal">
  <div class="modal-content" style="position:relative;">
    <button class="close-modal" onclick="closeModal()">√ó</button>
    <!-- Login -->
    <div id="loginForm">
      <h3 style="text-align:center">Student Login</h3>
      <div class="form-group"><label>Email</label><input id="loginEmail" type="email" placeholder="Enter your email"><div id="loginEmailError" class="error-msg">Please enter a valid email.</div></div>
      <div class="form-group"><label>Password</label><input id="loginPassword" type="password" placeholder="Password"><div id="loginPasswordError" class="error-msg">Password is required.</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn-primary" onclick="login()">Login</button>
        <!-- Use a button (type=button) so it will not navigate away -->
        <button type="button" class="btn-secondary" onclick="showForgotPassword()">Forgot Password?</button>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn-secondary" onclick="showSignup()">New Student? Register</button>
        <button class="btn-secondary" onclick="showAdminLogin()">Admin Login</button>
      </div>
    </div>

    <!-- Signup -->
    <div id="signupForm" style="display:none">
      <h3 style="text-align:center">Student Registration</h3>
      <div class="form-group"><label>Full Name</label><input id="signupName" placeholder="Full name"><div id="signupNameError" class="error-msg">Name is required</div></div>
      <div class="form-group"><label>Phone</label><input id="signupPhone" placeholder="10 digit phone" maxlength="10"><div id="signupPhoneError" class="error-msg">Valid phone required</div></div>
      <div class="form-group"><label>Email</label><input id="signupEmail" type="email" placeholder="Email"><div id="signupEmailError" class="error-msg">Valid email required</div></div>
      <div class="form-group"><label>Class</label>
        <select id="signupClass">
          <option value="">Select Class</option><option value="11">Class 11th</option><option value="12">Class 12th</option>
        </select>
        <div id="signupClassError" class="error-msg">Please select a class</div>
      </div>
      <div class="form-group"><label>Password</label><input id="signupPassword" type="password" placeholder="Min 6 characters"><div id="signupPasswordError" class="error-msg">Password must be at least 6 characters</div></div>
      <button class="btn-primary" onclick="signup()">Register</button>
      <button class="btn-secondary" onclick="showLogin()">Already registered? Login</button>
    </div>

    <!-- Admin -->
    <div id="adminLoginForm" style="display:none">
      <h3 style="text-align:center">Admin Login</h3>
      <div class="form-group"><label>Admin Email</label><input id="adminEmail" type="email"></div>
      <div class="form-group"><label>Password</label><input id="adminPassword" type="password"></div>
      <button class="btn-primary" onclick="adminLogin()">Admin Login</button>
      <button class="btn-secondary" onclick="showLogin()">Back to Student Login</button>
    </div>

    <!-- Forgot Password -->
    <div id="forgotPasswordForm" style="display:none">
      <h3 style="text-align:center">Reset Password</h3>
      <p class="small" style="text-align:center;margin-bottom:10px">Enter your registered email to receive a reset link.</p>
      <div class="form-group"><label>Email</label><input id="resetEmail" type="email" placeholder="Your registered email"><div id="resetEmailError" class="error-msg">Email is required</div></div>
      <button class="btn-primary" onclick="handleForgotPassword()">Send Reset Link</button>
      <button class="btn-secondary" onclick="showLogin()">Back to Login</button>
    </div>
  </div>
</div>

<!-- Main app shell -->
<div class="phone">
  <header>
    <div class="header-inner">
      <div class="logo-area">
        <img src="https://dviuwzzjkzodadgbotei.supabase.co/storage/v1/object/public/assets/WhatsApp%20Image%202025-10-12%20at%2021.58.17%20(1).jpeg" alt="logo">
        <div class="header-text">
          <h1>Phoenix English Classes</h1>
          <p>The Complete chapter-wise Learning Platform</p>
        </div>
      </div>
      <div>
        <button id="authButton" class="btn-secondary" onclick="showAuthModal()">üîí Login</button>
      </div>
    </div>
  </header>

  <div class="phone-content">
    <div class="nav-tabs">
      <div class="nav-tab active" onclick='showTab("courses")'>Courses</div>
      <div id="profileTab" class="nav-tab" onclick='showTab("profile")' style="display:none">My Profile</div>
      <div id="adminTab" class="nav-tab" onclick='showTab("admin")' style="display:none">Admin</div>
    </div>

    <div id="courses" class="tab-content active">
      <div id="coursesContainer"></div>
    </div>

    <div id="profile" class="tab-content" style="display:none">
      <div class="course-card">
        <h2>Student Profile</h2>
        <p class="summary"><strong>Name:</strong> <span id="profileName"></span></p>
        <p class="summary"><strong>Email:</strong> <span id="profileEmail"></span></p>
        <p class="summary"><strong>Phone:</strong> <span id="profilePhone"></span></p>
        <p class="summary"><strong>Class:</strong> <span id="profileClass"></span></p>
        <button class="btn-primary btn-secondary" onclick="showAlert('This feature will be added soon!')">Edit Profile</button>
      </div>
    </div>

    <div id="admin" class="tab-content" style="display:none;padding-top:6px">
      <div class="course-card">
        <h3>Content Management</h3>

        <div class="styled-select-group">
          <select id="adminCourse" onchange="loadChapters()">
            <option value="">Select Course</option>
            <option value="11en">Class 11 English</option>
            <option value="12en">Class 12 English</option>
            <option value="11hi">Class 11 Hindi</option>
            <option value="12hi">Class 12 Hindi</option>
          </select>

          <select id="adminChapter">
            <option value="">Select Chapter</option>
          </select>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin-bottom:8px">Video Lesson (YouTube link)</h4>
          <input id="videoUrl" placeholder="Paste YouTube URL here" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff">
          <button class="btn-primary" style="margin-top:8px;background:#c0392b" onclick='uploadContent("video")'>Upload Video Link</button>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin-bottom:8px">Explanation PDF</h4>
          <input id="explanationPdf" type="file" accept="application/pdf" style="width:100%">
          <button class="btn-primary" style="margin-top:8px" onclick='uploadContent("explanation")'>Upload PDF</button>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin-bottom:8px">Q&A PDF</h4>
          <input id="qaPdf" type="file" accept="application/pdf" style="width:100%">
          <button class="btn-primary" style="margin-top:8px" onclick='uploadContent("qa")'>Upload PDF</button>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Fullscreen content viewer (video player) -->
<div id="contentViewer" class="content-viewer">
  <div class="video-shell" id="videoShell">
    <!-- IFrame will be injected here -->
    <div id="videoFrameContainer" style="width:100%;height:100%;position:relative">
      <iframe id="videoPlayerIframe" allow="autoplay; encrypted-media; fullscreen" src="" allowfullscreen></iframe>
      <!-- Custom overlay controls (in addition to YouTube default controls) -->
      <div class="video-controls" id="videoControls" style="display:flex;gap:8px;">
        <button class="icon-btn" id="btnBack10" title="Back 10s">¬´ 10s</button>
        <button class="icon-btn" id="btnPlayPause" title="Play/Pause">‚èØ</button>
        <button class="icon-btn" id="btnForward10" title="Forward 10s">10s ¬ª</button>
        <input type="range" id="seekSlider" class="seek-slider" min="0" max="100" value="0" step="0.1">
        <div class="time-label" id="timeLabel">0:00 / 0:00</div>
        <select id="speedSelect" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);color:#fff;border:1px solid rgba(255,255,255,0.04)">
          <option value="0.25">0.25x</option><option value="0.5">0.5x</option><option value="0.75">0.75x</option><option selected value="1">1x</option>
          <option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="1.75">1.75x</option><option value="2">2x</option>
        </select>
        <button class="icon-btn" onclick="closeContentViewer()">Close ‚úï</button>
      </div>
    </div>
  </div>
</div>

<!-- Alerts/loading -->
<div id="custom-modal" class="modal" style="display:none">
  <div class="modal-content" style="text-align:center;max-width:420px">
    <h3 id="custom-modal-title">Notification</h3>
    <p id="custom-modal-text"></p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button class="btn-secondary" onclick="closeCustomModal()">Close</button>
    </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
<script>
/* ============================
   Basic app + theme + canvas
   ============================ */
document.addEventListener('DOMContentLoaded', function(){
  // simple stars/nebula canvas from original - minimal
  const canvas = document.getElementById('cosmic-canvas');
  if(canvas && canvas.getContext){
    const ctx = canvas.getContext('2d');
    function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);
    // simple moving stars
    const stars = [];
    for(let i=0;i<150;i++) stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.5+0.3,a:Math.random()});
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      stars.forEach(s=>{
        s.x += (Math.random()-0.5)*0.2;
        s.y += (Math.random()-0.5)*0.2;
        ctx.beginPath();
        ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
        ctx.fillStyle = 'rgba(255,255,255,'+(0.4+0.6*Math.random())+')';
        ctx.fill();
      });
      requestAnimationFrame(draw);
    }
    draw();
  }
});

/* ============================
   Small helpers & UI helpers
   ============================ */
function showAlert(msg, title='Notification'){ document.getElementById('custom-modal-title').innerText = title; document.getElementById('custom-modal-text').innerHTML = msg; document.getElementById('custom-modal').style.display = 'flex'; }
function closeCustomModal(){ document.getElementById('custom-modal').style.display = 'none'; }
function showAuthModal(){ document.getElementById('authModal').style.display = 'flex'; showLogin(); }
function closeModal(){ document.getElementById('authModal').style.display = 'none'; document.querySelectorAll('.error-msg').forEach(e=>e.style.display='none'); }
function showLogin(){ document.getElementById('loginForm').style.display='block'; document.getElementById('signupForm').style.display='none'; document.getElementById('adminLoginForm').style.display='none'; document.getElementById('forgotPasswordForm').style.display='none'; }
function showSignup(){ document.getElementById('loginForm').style.display='none'; document.getElementById('signupForm').style.display='block'; document.getElementById('adminLoginForm').style.display='none'; document.getElementById('forgotPasswordForm').style.display='none'; }
function showAdminLogin(){ document.getElementById('loginForm').style.display='none'; document.getElementById('signupForm').style.display='none'; document.getElementById('adminLoginForm').style.display='block'; document.getElementById('forgotPasswordForm').style.display='none'; }
function showForgotPassword(){ document.getElementById('loginForm').style.display='none'; document.getElementById('signupForm').style.display='none'; document.getElementById('adminLoginForm').style.display='none'; document.getElementById('forgotPasswordForm').style.display='block'; }

/* ============================
   Supabase config (keep your keys)
   ============================ */
const CONFIG = {
  SUPABASE_URL: 'https://dviuwzzjkzodadgbotei.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2aXV3enpqa3pvZGFkZ2JvdGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMjgwNDYsImV4cCI6MjA3NTYwNDA0Nn0.0OMnqJM166pcuZZw0E-5gl-ZY-6gO-RuoEX7hvxDF40'
};
const supabase = supabaseJs = supabase.createClient ? supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY) : supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

/* ============================
   Minimal mock of courses (keeps UI same)
   ============================ */
const courses = [
  { id:'11en', name:'Class 11th English', price:99, originalPrice:199, summary:'Complete chapter-wise English course for Class 11th', categories:[{title:'Prose', chapters:['Animals in Prison','Nalanda: Ancient Seat of Learning','A Snake in the Grass']},{title:'Poetry', chapters:['Where the Mind is without Fear','Stopping by Woods on a Snowy Evening']}]},
  { id:'12en', name:'Class 12th English', price:199, originalPrice:299, summary:'Board exam focused complete English preparation for Class 12th', categories:[{title:'Prose', chapters:['Indian Civilisation and Culture','Bharat is My Home']}]}
];

/* Simple placeholder for contentMetadata, will be fetched later */
let contentMetadata = {}; // key -> [types...]

/* ============================
   Render courses & chapter buttons
   ============================ */
let currentUser = null;
function renderCourses(){
  const container = document.getElementById('coursesContainer');
  container.innerHTML = '';
  courses.forEach(c=>{
    const card = document.createElement('div'); card.className='course-card';
    const enrolled = currentUser && (currentUser.purchased_courses || []).includes(c.id);
    let inner = `<h2>${c.name}</h2><div class="summary">${c.summary}</div><div style="margin-top:10px;font-size:13px;color:rgba(255,255,255,0.8)">Price: ‚Çπ${c.price}</div>`;
    inner += '<div style="margin-top:10px">';
    c.categories.forEach(cat=>{
      inner += `<div style="margin-top:8px"><strong style="display:block">${cat.title}</strong>`;
      cat.chapters.forEach(ch=>{
        const key = `${c.id}-${cat.title}-${ch}`;
        const available = contentMetadata[key] || [];
        let btns = '';
        if(available.includes('video')) btns += `<button class="btn-secondary" style="margin-top:6px;margin-right:6px" onclick="openContent('${c.id}','${cat.title}','${ch}','video')">‚ñ∂ Watch Video</button>`;
        if(available.includes('explanation')) btns += `<button class="btn-secondary" style="margin-top:6px;margin-right:6px" onclick="openContent('${c.id}','${cat.title}','${ch}','explanation')">üìñ Read PDF</button>`;
        if(available.length===0) btns = '<div class="small" style="margin-top:6px;opacity:0.7">Content coming soon...</div>';
        inner += `<div style="margin-top:6px">${ch}<div style="margin-top:6px">${btns}</div></div>`;
      });
      inner += `</div>`;
    });
    inner += '</div>';
    if(!enrolled) inner += `<div style="margin-top:12px"><button class="btn-primary" onclick="initiatePayment('${c.id}','${c.name}',${c.price})">üõí Enroll Now</button></div>`;
    else inner += `<div style="margin-top:12px"><div class="small" style="color:#28a745">‚úÖ Enrolled</div></div>`;
    card.innerHTML = inner;
    container.appendChild(card);
  });
}

/* ============================
   Fake session check (call your own backend logic)
   ============================ */
async function checkUserSession(){
  // This sample file keeps the original Supabase logic but won't auto sign in.
  // If you want full auth, keep checkUserSession() and initialization from your original file.
  // For now just render courses and try to fetch content metadata.
  await fetchContentMetadata();
  renderCourses();
}
checkUserSession();

/* ============================
   Fetch content metadata (used to show which items available)
   ============================ */
async function fetchContentMetadata(){
  try{
    const { data, error } = await supabase.from('content').select('course_id,category,chapter,type');
    if(error && error.message) {
      console.warn('content metadata fetch warning:', error.message);
      // still safe to continue
      contentMetadata = {};
      return;
    }
    contentMetadata = {};
    (data || []).forEach(item=>{
      const key = `${item.course_id}-${item.category}-${item.chapter}`;
      if(!contentMetadata[key]) contentMetadata[key] = [];
      if(!contentMetadata[key].includes(item.type)) contentMetadata[key].push(item.type);
    });
  }catch(e){
    console.error('Failed to fetch content metadata:', e);
    contentMetadata = {};
  }
}

/* ============================
   Upload content (video/pdf) - safer insert-or-update
   ============================ */
async function uploadContent(type){
  // type: video | explanation | qa
  const courseId = document.getElementById('adminCourse').value;
  const chapter = document.getElementById('adminChapter').value;
  if(!courseId || !chapter){ showAlert('Please select course and chapter first.','Error'); return; }

  if(type === 'video'){
    const url = document.getElementById('videoUrl').value.trim();
    if(!url){ showAlert('Please paste YouTube URL.','Error'); return; }
    // extract best possible video id
    const vid = extractYouTubeID(url);
    if(!vid){ showAlert('Invalid YouTube URL.','Error'); return; }
    const payload = {
      course_id: courseId,
      category: chapter.split(' - ')[0] || chapter,
      chapter: chapter,
      type: 'video',
      url: `https://www.youtube.com/watch?v=${vid}`,
      uploaded_at: new Date().toISOString()
    };
    await safeInsertOrUpdateContent(payload);
  } else if(type === 'explanation' || type === 'qa'){
    const fileInput = type === 'explanation' ? document.getElementById('explanationPdf') : document.getElementById('qaPdf');
    const file = fileInput.files && fileInput.files[0];
    if(!file){ showAlert('Please choose a PDF file.','Error'); return; }
    // We'll upload file to Supabase storage first (content-pdfs), then insert content record with URL
    try{
      const fileName = `${courseId}_${chapter.replace(/\s+/g,'_')}_${type}_${Date.now()}.pdf`;
      const uploadResult = await supabase.storage.from('content-pdfs').upload(fileName, file, { cacheControl: '3600', upsert: true });
      if(uploadResult.error) throw uploadResult.error;
      const publicURL = supabase.storage.from('content-pdfs').getPublicUrl(uploadResult.data.path).publicUrl;
      const payload = {
        course_id: courseId,
        category: chapter.split(' - ')[0] || chapter,
        chapter: chapter,
        type: (type==='explanation' ? 'explanation' : 'qa'),
        url: publicURL,
        uploaded_at: new Date().toISOString()
      };
      await safeInsertOrUpdateContent(payload);
    }catch(e){
      console.error('File upload error:', e);
      showAlert('File upload failed: '+(e.message||e),'Error');
    }
  }
}

/* safer insert or update (avoid relying on ON CONFLICT unique constraint on DB) */
async function safeInsertOrUpdateContent(payload){
  try{
    // Try insert
    const insertRes = await supabase.from('content').insert(payload).select();
    if(insertRes.error){
      // If insertion failed due to unique violation, update existing row(s)
      console.warn('Insert error, trying update:', insertRes.error.message || insertRes.error);
      // Try update by matching course_id, category, chapter, type
      const updateRes = await supabase.from('content')
        .update({ url: payload.url, uploaded_at: payload.uploaded_at })
        .eq('course_id', payload.course_id)
        .eq('category', payload.category)
        .eq('chapter', payload.chapter)
        .eq('type', payload.type);
      if(updateRes.error){
        throw updateRes.error;
      } else {
        showAlert('Content updated successfully!', 'Success');
      }
    } else {
      showAlert('Content uploaded successfully!', 'Success');
    }
    // refresh metadata & UI
    await fetchContentMetadata();
    renderCourses();
  }catch(e){
    console.error('safe insert/update failed:', e);
    // If the DB has some other constraint, inform developer/admin
    showAlert('Upload failed: ' + (e.message || e) + '<br><br>If you see a database unique constraint error, run: <code>ALTER TABLE content ADD CONSTRAINT content_unique UNIQUE (course_id, category, chapter, type);</code>','Error');
  }
}

/* extract youtube id helper */
function extractYouTubeID(url){
  // handles multiple url patterns
  try{
    const u = new URL(url);
    if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    if(u.searchParams.get('v')) return u.searchParams.get('v');
    // embed path maybe /embed/ID
    const parts = u.pathname.split('/');
    return parts.includes('embed') ? parts.pop() : null;
  }catch(e){
    // fallback with regex
    const m = url.match(/(?:v=|\/embed\/|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
    return m ? m[1] : null;
  }
}

/* ============================
   Open content (video/pdf)
   ============================ */
async function openContent(courseId, category, chapter, type){
  // check enrollment: here we simply allow (you can enforce)
  // find content record
  try{
    const { data, error } = await supabase.from('content').select('url,type').eq('course_id', courseId).eq('category', category).eq('chapter', chapter).eq('type', type).limit(1).single();
    if(error || !data) { showAlert('Content not found.','Error'); return; }
    if(type === 'video'){
      // Build embed URL with params and enable JS API
      const url = data.url;
      const vid = extractYouTubeID(url);
      if(!vid) { showAlert('Invalid video link stored.','Error'); return; }
      openVideoPlayerFullScreen(vid, true); // autoplay in fullscreen
    } else {
      // PDF: open in content viewer (use Google docs viewer for embedding)
      const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(data.url)}&embedded=true`;
      // We'll open viewer in new tab for better mobile behavior
      window.open(viewerUrl, '_blank');
    }
  }catch(e){
    console.error('openContent error:', e);
    showAlert('Failed to load content.','Error');
  }
}

/* ============================
   Fullscreen YouTube Player
   ============================ */
/* We'll use postMessage-friendly iframe (YouTube IFrame API) to control playback. */
let ytPlayer = null;
let ytTimer = null;
function openVideoPlayerFullScreen(videoId, autoplay=true){
  const viewer = document.getElementById('contentViewer');
  const iframe = document.getElementById('videoPlayerIframe');
  // Build embed URL with recommended params
  const params = new URLSearchParams({
    enablejsapi: '1',
    origin: location.origin,
    playsinline: '1',
    rel: '0',
    modestbranding: '1',
    iv_load_policy: '3',
    controls: '1',
    fs: '1',
    // 'autoplay' param triggers autoplay only when allowed by browser; we'll call play via API
    autoplay: autoplay ? '1' : '0'
  });
  iframe.src = `https://www.youtube.com/embed/${videoId}?${params.toString()}`;
  // show viewer, request fullscreen on container for immersive experience
  viewer.style.display = 'flex';

  // attempt fullscreen on container to get immersive playback (some browsers require user gesture; this is triggered by clicking a chapter button)
  const container = document.getElementById('contentViewer');
  if(container.requestFullscreen) container.requestFullscreen().catch(()=>{});
  else if(container.webkitRequestFullscreen) container.webkitRequestFullscreen().catch(()=>{});
  else if(container.msRequestFullscreen) container.msRequestFullscreen().catch(()=>{});

  // ensure we can control the iframe after it loads - set up message-based control using YT API
  // remove any old ytPlayer listeners
  if(ytTimer) { clearInterval(ytTimer); ytTimer = null; }

  // initialize event listeners for controls (they use postMessage to the iframe)
  setupVideoControlBindings();
  // start a small poll to update the seek slider from iframe via postMessage getCurrentTime through YT iframe API
  startYTStatePoll();
}

/* postMessage helpers for basic commands via YT IFrame API */
function postToYT(commandName, args){
  const iframe = document.getElementById('videoPlayerIframe');
  if(!iframe || !iframe.contentWindow) return;
  const message = JSON.stringify({ event: 'command', func: commandName, args: args || [] });
  iframe.contentWindow.postMessage(message, '*');
}

/* control binding */
function setupVideoControlBindings(){
  const playBtn = document.getElementById('btnPlayPause');
  const backBtn = document.getElementById('btnBack10');
  const forwardBtn = document.getElementById('btnForward10');
  const seekSlider = document.getElementById('seekSlider');
  const timeLabel = document.getElementById('timeLabel');
  const speedSelect = document.getElementById('speedSelect');

  // Play/Pause
  playBtn.onclick = async function(){
    postToYT('getPlayerState'); // request state ‚Äî we'll toggle via playVideo/pauseVideo
    // For simplicity we will just send playVideo command (YT will toggle appropriately)
    postToYT('playVideo');
  };
  // Back 10s
  backBtn.onclick = function(){
    postToYT('getCurrentTime');
    // We'll use a short delayed strategy: request time and then seek to time-10
    window.addEventListener('message', handleTempTimeBack, { once:true });
    postToYT('getCurrentTime');
  };
  function handleTempTimeBack(ev){
    try{
      const d = typeof ev.data === 'string' ? JSON.parse(ev.data) : ev.data;
      if(d && d.info && typeof d.info === 'number'){
        const t = Math.max(0, d.info - 10);
        postToYT('seekTo',[t, true]);
      }
    }catch(e){}
  }
  // Forward 10s
  forwardBtn.onclick = function(){
    window.addEventListener('message', handleTempTimeForward, { once:true });
    postToYT('getCurrentTime');
  };
  function handleTempTimeForward(ev){
    try{
      const d = typeof ev.data === 'string' ? JSON.parse(ev.data) : ev.data;
      if(d && d.info && typeof d.info === 'number'){
        const t = d.info + 10;
        postToYT('seekTo',[t, true]);
      }
    }catch(e){}
  }

  // Seek slider: when user changes value, seek
  let seeking = false;
  seekSlider.oninput = function(){
    seeking = true;
    const pct = parseFloat(this.value);
    // We'll get duration and then compute target when we have it via a short poll message
    window.addEventListener('message', handleTempDurationSeek, { once:true });
    postToYT('getDuration');
    function handleTempDurationSeek(ev){
      try{
        const d = typeof ev.data === 'string' ? JSON.parse(ev.data) : ev.data;
        if(d && d.info && typeof d.info === 'number'){
          const duration = d.info;
          const target = duration * (pct/100);
          postToYT('seekTo',[target,true]);
        }
      }catch(e){}
      seeking = false;
    }
  };

  // Speed select
  speedSelect.onchange = function(){
    const rate = parseFloat(this.value);
    postToYT('setPlaybackRate', [rate]);
  };

  // update label via the poller (see startYTStatePoll())
}

/* start poll to update slider/time using getCurrentTime/getDuration via postMessage polling */
function startYTStatePoll(){
  const slider = document.getElementById('seekSlider');
  const timeLabel = document.getElementById('timeLabel');

  if(ytTimer) clearInterval(ytTimer);
  ytTimer = setInterval(async ()=>{
    // ask iframe for current time and duration
    postToYT('getCurrentTime');
    postToYT('getDuration');
    // We handle the responses in the message event below
  }, 700);

  // listen for messages from iframe
  window.addEventListener('message', ytMessageHandler);
}

/* yt message handler to parse YT API responses */
function ytMessageHandler(e){
  // The iframe posts messages as JSON strings; YT forwards method results under e.data
  // Example patterns are not strictly documented here; we'll handle common ones:
  try{
    let data = e.data;
    if(typeof data === 'string'){
      try{ data = JSON.parse(data); } catch(err){ /* not JSON ‚Äî ignore */ }
    }
    if(!data) return;
    // YT sometimes replies with { event: 'infoDelivery', info: ... } or { info: ... }
    if(data && data.info !== undefined){
      // info might be currentTime or duration depending on last command; we must infer via structure
      // If info is integer/float and between 0 and 1e6, we can use heuristics.
      const info = data.info;
      // If last message was duration (likely large), update duration.
      // We'll store lastDuration locally if > 1 minute or > current known time.
      // Simpler: update slider proportionally when both currentTime and duration obtained in close succession.
      // We'll manage two temp vars:
      window._yt_lastInfo = window._yt_lastInfo || {};
      if(info >= 0){
        // Determine if message includes 'duration' or 'current' by comparisons:
        const dur = window._yt_knownDuration || 0;
        if(info > dur){ window._yt_knownDuration = info; } else {
          window._yt_knownCurrent = info;
        }
      }
    }
    // If message contains an 'event' that includes infoDelivery with a methodName, parse that (some YT versions):
    if(data && data.event === 'infoDelivery' && data.info && data.info.length){
      // ignore complex shapes
    }
  }catch(err){
    // ignore parse failures
  }

  // Update UI if we have both knownDuration and knownCurrent
  const slider = document.getElementById('seekSlider');
  const timeLabel = document.getElementById('timeLabel');
  const curr = window._yt_knownCurrent || 0;
  const dur = window._yt_knownDuration || 0;
  if(dur > 0){
    const pct = (curr / dur) * 100;
    if(!isNaN(pct) && isFinite(pct)) slider.value = pct;
  }
  // update time label
  function fmt(s){ s = Math.max(0, Math.floor(s||0)); const m = Math.floor(s/60); const sec = s%60; return `${m}:${sec.toString().padStart(2,'0')}`; }
  timeLabel.innerText = `${fmt(curr)} / ${dur > 0 ? fmt(dur) : '0:00'}`;
}

/* stop poll when closing */
function stopYTStatePoll(){
  if(ytTimer) clearInterval(ytTimer);
  ytTimer = null;
  window.removeEventListener('message', ytMessageHandler);
}

/* close viewer */
function closeContentViewer(){
  const viewer = document.getElementById('contentViewer');
  viewer.style.display = 'none';
  // stop playback by clearing src and stopping poll
  const iframe = document.getElementById('videoPlayerIframe');
  iframe.src = '';
  stopYTStatePoll();
  // exit fullscreen if active
  if(document.fullscreenElement) document.exitFullscreen && document.exitFullscreen().catch(()=>{});
}

/* ============================
   Auth / signup / login / forgot password (minimal)
   ============================ */
function validateEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
function showTab(name){
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  document.getElementById(name).style.display='block';
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>{ if(t.getAttribute('onclick') && t.getAttribute('onclick').includes(name)) t.classList.add('active'); });
}

/* Signup/login/forgot simplified: adapt to your original logic */
async function signup(){
  const name = document.getElementById('signupName').value.trim();
  const phone = document.getElementById('signupPhone').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const cls = document.getElementById('signupClass').value;
  const pw = document.getElementById('signupPassword').value;
  let has=false;
  if(!name){ document.getElementById('signupNameError').style.display='block'; has=true; } else document.getElementById('signupNameError').style.display='none';
  if(!/^\d{10}$/.test(phone)){ document.getElementById('signupPhoneError').style.display='block'; has=true; } else document.getElementById('signupPhoneError').style.display='none';
  if(!validateEmail(email)){ document.getElementById('signupEmailError').style.display='block'; has=true; } else document.getElementById('signupEmailError').style.display='none';
  if(!cls){ document.getElementById('signupClassError').style.display='block'; has=true; } else document.getElementById('signupClassError').style.display='none';
  if((pw||'').length < 6){ document.getElementById('signupPasswordError').style.display='block'; has=true; } else document.getElementById('signupPasswordError').style.display='none';
  if(has) return;
  try{
    const finger = await FingerprintJS.load();
    const f = await finger.get();
    const visitorId = f.visitorId;
    const { data, error } = await supabase.auth.signUp({ email, password: pw });
    if(error) throw error;
    // create profile
    await supabase.from('users').insert({ id: data.user.id, name: name, phone: phone, email: email, student_class: cls, purchased_courses: [], is_admin: false, device_fingerprint: visitorId });
    currentUser = { id: data.user.id, name, email, phone, student_class: cls, purchased_courses: [] };
    showAlert('Registration successful! Welcome '+name,'Success');
    closeModal();
    renderCourses();
  }catch(e){
    console.error(e);
    showAlert('Registration failed: '+(e.message || e),'Error');
  }
}

async function login(){
  const email = document.getElementById('loginEmail').value.trim();
  const pw = document.getElementById('loginPassword').value;
  if(!validateEmail(email)){ document.getElementById('loginEmailError').style.display='block'; return; } else document.getElementById('loginEmailError').style.display='none';
  if(!pw){ document.getElementById('loginPasswordError').style.display='block'; return; } else document.getElementById('loginPasswordError').style.display='none';
  try{
    const finger = await FingerprintJS.load(); const f = await finger.get(); const visitorId = f.visitorId;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pw });
    if(error) throw error;
    // fetch profile
    const { data: profile, error: perr } = await supabase.from('users').select('*').eq('id', data.user.id).single();
    if(perr) throw perr;
    currentUser = profile;
    showAlert('Login successful!','Success');
    closeModal();
    renderCourses();
  }catch(e){
    console.error(e);
    showAlert('Login failed: '+(e.message||e));
  }
}

async function handleForgotPassword(){
  const email = document.getElementById('resetEmail').value.trim();
  if(!validateEmail(email)){ document.getElementById('resetEmailError').style.display='block'; return; } else document.getElementById('resetEmailError').style.display='none';
  try{
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
    if(error) throw error;
    showAlert('Password reset link sent. Check your email.','Success');
    showLogin();
  }catch(e){
    console.error(e);
    showAlert('Failed to send reset link: '+(e.message||e),'Error');
  }
}

/* Admin: load chapters for a course (simple example) */
function loadChapters(){
  const course = document.getElementById('adminCourse').value;
  const chapterSelect = document.getElementById('adminChapter');
  chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
  if(!course) return;
  const c = courses.find(x => x.id === course);
  if(c){
    c.categories.forEach(cat=>{
      cat.chapters.forEach(ch=>{
        const opt = document.createElement('option');
        opt.value = ch;
        opt.textContent = `${ch}`;
        chapterSelect.appendChild(opt);
      });
    });
  }
}

/* Payment placeholder */
function initiatePayment(courseId, courseName, price){
  showAlert(`Payment flow not implemented in this demo. Start payment for ${courseName} (‚Çπ${price})`,'Payment');
}

/* small init */
document.addEventListener('DOMContentLoaded', () => {
  renderCourses();
});
</script>
</body>
</html>
